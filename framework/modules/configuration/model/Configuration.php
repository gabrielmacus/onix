<?php
/**
 * Created by PhpStorm.
 * User: Gabriel
 * Date: 24/01/2018
 * Time: 02:40 PM
 */

namespace framework\modules\configuration\model;



use framework\modules\base\model\Base;
use framework\modules\fileStorage\model\FileStorage;
use framework\services\UrlService;

class Configuration extends FileStorage
{
    static function Model()
    {
        $model = Base::Model();

        $model["_id"]= ["value"=>"",'printable'=>false];
        //TESTING,DEVELOPMENT or PRODUCTION
        $model["env"] =["value"=>"DEVELOPMENT"];

        $model["active"] = ["value"=>false];


        //App parameters
        $model["app_name"]= ["value"=>""];
        $model["app_url"]= ["value"=>UrlService::CurrentUrl()];
        //TODO: set an id for every app that is deployed
        $model["app_id"] = ["value"=>""];

        //Site parameters
        $model["site_name"]= ["value"=>""];
        $model["site_url"] =  ["value"=>""];

        //DB config
        $model["db_name"]=["value"=>""];
        $model["db_user"]=["value"=>""];
        $model["db_pass"]=["value"=>""];
        $model["db_port"]=["value"=>""];
        $model["db_host"]=["value"=>""];

        //Email parameters
        $model["email_host"] = ["value"=>""];
        //$model["email_smtp_auth"]= ["value"=>true];
        //If empty, email smtp auth is false
        $model["email_smtp_secure"]= ["value"=>"tls"];
        $model["email_username"] = ["value"=>""];
        $model["email_password"]= ["value"=>""];
        $model["email_port"]= ["value"=>587];


        return $model;
    }



    public function rules()
    {
        $rules = parent::rules();

        $rules[] = ['InRange','db_port',[1,65535,true] ,"portRangeAllowed:1,65535"];

        $rules[] = ['MatchesExp','app_name',['^[a-zA-Z0-9_. -]{5,30}$'],'appNameNotAllowed'];

        //$rules[] = ["IsUrl",'app_url',[],'invalidUrl'];

        $rules[] = ["MatchesExp",'site_name',['^[a-zA-Z0-9_. -]{5,40}$',true],'siteNameNotAllowed'];

        $rules[] = ["IsUrl",'site_url',[true],'invalidUrl'];



        $rules[] = ["IsIP",'db_host',[],'invalidIp'];

        $rules[] = ['NotEmpty','db_user',[] ,"shouldntBeEmpty"];

        $rules[] = ['MatchesLength','db_name',[2,100],'lengthBetween:2,100'];



        $rules[] = ["IsEmail","email_username",[],'mainEmailNotValid'];

        $rules[] = ["IsUrl","email_host",[],'invalidUrl'];

        $rules[] = ['InRange','email_port',[1,65535,true] ,"portRangeAllowed:1,65535"];

        $rules[] = ['InRange','email_password',[1,65535,true] ,"shouldntBeEmpty"];









        return $rules;
    }

    static function BeforeUpdate(Base &$obj)
    {
        parent::BeforeUpdate($obj); // TODO: Change the autogenerated stub
    }



}